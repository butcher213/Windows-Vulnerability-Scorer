import os, sys
import win32api
import win32security
import ntsecuritycon as con
import configVariables as cv

#init the totalpoints, pointsScored, and htmlOutput variables


def show_cacls (filename):
    calcs = []
    finalCacls = []
    groupsSeen = []
    for line in os.popen ("cacls %s" % filename).read ().splitlines ():
        calcs.append(line)
    calcs[0] = calcs[0].split(filename)[1]
    # split the calcs for duplicates and redundant lines
    for cacl in calcs:
        # remove spaces
        cacl = cacl.replace(' ', '')
        if '\\' in cacl:
            finalCacls.append(cacl)
        else:
            a = 0
    # return the cacl value
    return finalCacls


def scorePermissions():
    pointsScored = 0
    totalPoints = 0
    htmlOutput = ''
    if cv.FPV_scorePermissions == True:
        # set the totalPoints value
        totalPoints = len(cv.FPV_Permissions)
        # loop through the stuff retrieved from configVariables
        for filePermission in cv.FPV_Permissions:
            checkedFile = filePermission[0]
            # correct for slash errors in the header file
            filePermission[0].replace('/', '\\')
            fileToCheckPermissions = show_cacls (filePermission[0])
            # loop through the returned cacls permissions
            specialAccess = False
            for line in fileToCheckPermissions:
                # check to see if the  requested group has a file permission 
                if filePermission[1] in line:
                    # save the current permission value, which is the last value in the line.
                    # if the header asks for 'w', show_cacls says it is "(special access:)"
                    if filePermission[2].lower() == 'w':
                        # check to see if "(special access:)" is in the cacl value
                        if '(specialaccess:)' in line:
                            pointsScored += 1
                            #print("scored")
                            htmlOutput += '<li>The "'+ filePermission[1] + '" user/group has write access to the "' + checkedFile + '" directory.</li>'
                    else:
                        currentPermission = line[-1]
                        # if user has full control
                        if currentPermission.upper() == 'F':
                            if filePermission[2].upper() == 'F':
                                pointsScored += 1
                                htmlOutput += '<li>The "'+ filePermission[1] + '" user/group has full control of the "' + checkedFile + '" directory.</li>'
                            break
                        # if user has change access
                        elif currentPermission.upper() == 'C':
                            if filePermission[2].upper() == 'C':
                                pointsScored += 1
                                htmlOutput += '<li>The "'+ filePermission[1] + '" user/group has change access to the "' + checkedFile + '" directory.</li>'
                            break
                        # if user has read-only access
                        elif filePermission[2].upper() == 'R':
                            if '(specialaccess:)' in line:
                                specialAccess = True
                            if specialAccess == False:
                                pointsScored += 1
                                htmlOutput += '<li>The "'+ filePermission[1] + '" user/group has read-only access to the "' + checkedFile + '" directory.</li>'
                                break
 
    return [pointsScored, totalPoints, htmlOutput]  
    #print(str(stuff))

